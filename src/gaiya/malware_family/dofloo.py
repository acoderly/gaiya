import logging.handlers
from gaiya.malware_family import Alpha
import gaiya.malware_family.config as config
import os
import subprocess
import time


class dofloo(Alpha):
    NAME = "dofloo"

    def __init__(self):
        super(dofloo, self).__init__()
        self.logger = self._init_logger()

    def _init_logger(self):
        log_file = os.path.join(os.path.dirname(__file__), f"{self.NAME}_log.txt")
        handler = logging.handlers.RotatingFileHandler(log_file, maxBytes=1024 * 1024, backupCount=10)
        handler.setFormatter(logging.Formatter("%(asctime)s-:%(message)s"))
        logger = logging.getLogger(f"{self.NAME}_log")
        logger.addHandler(handler)
        logger.setLevel(logging.INFO)
        return logger

    def run_ida_script(self, ida_exe, ida_script, file):
        print("=" * 10, "Run ida python script.", "=" * 10)
        cmd = f"\"{ida_exe}\" -c -A \"-S{ida_script}\" \"{file}\""
        try:
            os.popen(cmd)
            time.sleep(2)
        except Exception as e:
            print("[******] run_ida_script error.<{}>".format(e))

    def run(self):
        self.logger.info(f"dofloo run {config.IDA_EXE_INSTALLED_PATH}")
        self.copy_script_to_ida()
        self.run_ida_script(config.IDA_EXE_INSTALLED_PATH,
                            "/Applications/IDAPro7.0/ida.app/Contents/MacOS/python/gaiya/dofloo/armel/extract.py /Users/orcsir/pycharm_project/git/gaiya/src/gaiya/ida_python_script/dofloo/armel",
                            "/Users/orcsir/pycharm_project/git/gaiya/src/gaiya/sample/05b840bbc02dd794a2858dad1b367f84")
